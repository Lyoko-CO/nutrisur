{% extends 'base.html' %}
{% load static %}

{% block title %} Reserva tu Cita {% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'citas/css/chatbot.css' %}">

<div class="container-fluid px-4 py-4">
    <h2 class="text-center mb-4 text-dark" style="color: #000000 !important;">Reserva tu masaje</h2>

    <div class="row">
        
        <div class="col-12 col-lg-5 mb-4 order-2 order-lg-1">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white text-center py-3">
                    <h5 class="mb-0 text-muted"><i class="bi bi-calendar-check"></i> Datos de la reserva</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Concepto</th>
                                    <th class="text-end pe-4">Detalle</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-resumen">
                                <tr>
                                    <td class="ps-4 text-secondary">D√≠a</td>
                                    <td class="text-end pe-4 fw-bold text-primary" id="res-fecha">
                                        {{ cita_actual.fecha|date:"d/m/Y"|default:"-" }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="ps-4 text-secondary">Hora</td>
                                    <td class="text-end pe-4 fw-bold" id="res-hora">
                                        {% if cita_actual.fecha %}
                                            {% if cita_actual.fecha.hour == 0 and cita_actual.fecha.minute == 0 %}
                                                <span class="text-danger">Pendiente</span>
                                            {% else %}
                                                {{ cita_actual.fecha|date:"H:i" }}
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="ps-4 text-secondary">Observaciones</td>
                                    <td class="text-end pe-4 text-muted fst-italic" id="res-obs">
                                        {{ cita_actual.observaciones|default:"-" }}
                                    </td>
                                </tr>
                                <tr class="table-light">
                                    <td class="ps-4 fw-bold">Estado</td>
                                    <td class="text-end pe-4" id="res-estado">
                                        {% if cita_actual.estado == 'PENDIENTE' %}
                                            <span class="badge bg-success">Confirmada</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">En proceso</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="border-top"></div>
                        <div class="bg-light p-4 rounded-bottom">
                            
                            <h6 class="text-uppercase text-muted fw-bold mb-4" style="font-size: 0.8rem; letter-spacing: 1px;">
                                Informaci√≥n de inter√©s
                            </h6>

                            <div class="d-flex mb-3 align-items-start">
                                <div class="icon-box text-danger bg-white shadow-sm me-3">
                                    <i class="bi bi-geo-alt-fill"></i>
                                </div>
                                <div>
                                    <span class="d-block fw-bold text-dark" style="font-size: 0.95rem;">Direcci√≥n</span>
                                    <span class="text-muted small">Av. Santa Lucia 62,<br>Alcal√° de Guada√≠ra, Sevilla</span>
                                </div>
                            </div>

                            <div class="d-flex mb-3 align-items-start">
                                <div class="icon-box text-warning bg-white shadow-sm me-3">
                                    <i class="bi bi-clock-fill"></i>
                                </div>
                                <div>
                                    <span class="d-block fw-bold text-dark" style="font-size: 0.95rem;">Horario</span>
                                    <span class="text-muted small">10:00 a 14:00<br>17:00 a 21:00</span>
                                </div>
                            </div>

                            <div class="d-flex align-items-start">
                                <div class="icon-box text-primary bg-white shadow-sm me-3">
                                    <i class="bi bi-hourglass-split"></i>
                                </div>
                                <div>
                                    <span class="d-block fw-bold text-dark" style="font-size: 0.95rem;">Duraci√≥n sesi√≥n</span>
                                    <span class="text-muted small">1 hora aprox.</span>
                                </div>
                            </div>

                        </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-7 mb-4 order-1 order-lg-2">
            <div class="card shadow-sm border-0">
                
                <div class="card-body p-0">
                    <div id="chat-window" >
                        <div class="chat-message bot" style="background: #f9f9f9;">
                            <strong>NutriBot:</strong> {{ mensaje_inicial|safe }}
                        </div>
                    </div>
                </div>

                <div class="card-footer bg-white py-3">
                    <form id="chat-form">
                        <div class="input-group input-group-lg">
                            <input type="text" id="chat-input" class="form-control" placeholder="Escribe o habla..." required>
                            <button type="button" id="btn-voz" class="btn btn-outline-secondary" title="Activar lectura en voz alta">
                                üîá
                            </button>
                            <button type="button" id="btn-micro" class="btn btn-outline-secondary" title="Hablar">
                                <span id="micro-icon">üéôÔ∏è</span>
                            </button>
                            <button type="submit" id="btn-enviar" class="btn btn-primary px-4">Enviar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const procesarMensajeURL = "{% url 'procesar_mensaje_cita' %}"; 
    const csrfToken = "{{ csrf_token }}";
    
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    // Referencias a celdas de la tabla
    const resFecha = document.getElementById('res-fecha');
    const resHora = document.getElementById('res-hora');
    const resObs = document.getElementById('res-obs');
    const resEstado = document.getElementById('res-estado');

    function addMessage(sender, text) {
        const div = document.createElement('div');
        div.className = `chat-message ${sender === 'T√∫' ? 'user' : 'bot'}`;
        div.innerHTML = `<strong>${sender}:</strong> ${text}`;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function actualizarTabla(datos) {
        if (!datos) {
            resFecha.innerText = "-";
            resHora.innerText = "-";
            resObs.innerText = "-";
            resEstado.innerHTML = '<span class="badge bg-secondary">Reiniciado</span>';
            return;
        }

        // 1. Fecha
        resFecha.innerText = datos.fecha || "-";

        // 2. Hora
        if (datos.hora === 'Pendiente') {
            resHora.innerHTML = '<span class="text-danger fw-bold">?</span>';
        } else {
            resHora.innerText = datos.hora || "-";
        }

        // 3. Observaciones
        resObs.innerText = datos.observaciones || "-";

        // 4. Estado
        if (datos.estado === 'PENDIENTE') {
            resEstado.innerHTML = '<span class="badge bg-success">Confirmada</span>';
        } else {
            resEstado.innerHTML = '<span class="badge bg-warning text-dark">En proceso</span>';
        }
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const texto = chatInput.value.trim();
        if (!texto) return;

        addMessage('T√∫', texto);
        chatInput.value = '';
        chatInput.disabled = true; 

        try {
            const res = await fetch(procesarMensajeURL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ mensaje: texto })
            });
            
            const data = await res.json();
            
            addMessage('NutriBot', data.respuesta_bot);
            leerTexto(data.respuesta_bot);
            
            if (data.status === 'reset') actualizarTabla(null);
            else if (data.datos_cita) actualizarTabla(data.datos_cita);

            if (data.status === 'finalizado') {
                chatInput.placeholder = "¬°Cita Confirmada! Pulsa Listo para salir.";
                const btnEnviar = document.getElementById('btn-enviar');
                btnEnviar.classList.replace('btn-primary', 'btn-success'); 
                btnEnviar.textContent = "Listo";
                btnEnviar.type = "button";
                btnEnviar.onclick = function() {
                    window.location.href = '/citas/mis-citas';
                };
                btnEnviar.disabled = false;
            } else {
                chatInput.disabled = false;
                chatInput.focus();
            }
            
        } catch (err) {
            console.error(err);
            addMessage('Sistema', 'Error de conexi√≥n.');
            chatInput.disabled = false;
        }
    });

    const btnMicro = document.getElementById('btn-micro');
    const microIcon = document.getElementById('micro-icon');

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.lang = 'es-ES'; // Idioma espa√±ol
        recognition.continuous = false; // Para de escuchar al terminar la frase
        recognition.interimResults = false; // Solo resultados finales

        // Al pulsar el micro
        btnMicro.addEventListener('click', () => {
            if (btnMicro.classList.contains('recording')) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        // Cuando empieza a escuchar
        recognition.onstart = () => {
            btnMicro.classList.add('recording');
            btnMicro.classList.replace('btn-outline-secondary', 'btn-danger'); // Se pone rojo
            microIcon.textContent = '‚èπÔ∏è'; // Icono de stop
            chatInput.placeholder = "Te escucho...";
        };

        // Cuando termina (por silencio o stop manual)
        recognition.onend = () => {
            btnMicro.classList.remove('recording');
            btnMicro.classList.replace('btn-danger', 'btn-outline-secondary'); // Vuelve a gris
            microIcon.textContent = 'üéôÔ∏è';
            chatInput.placeholder = "Escribe tu mensaje...";
            chatInput.focus();
        };

        // Cuando recibe el texto
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            chatInput.value = transcript; // Escribe lo que has dicho
            
            // Opcional: Enviar autom√°ticamente tras hablar
            // setTimeout(() => chatForm.dispatchEvent(new Event('submit')), 500);
        };

        // Manejo de errores
        recognition.onerror = (event) => {
            console.error("Error de voz:", event.error);
            btnMicro.classList.remove('recording');
            // Restaurar estilo si falla
            btnMicro.classList.replace('btn-danger', 'btn-outline-secondary');
            microIcon.textContent = 'üéôÔ∏è';
        };

    } else {
        // Si el navegador es muy antiguo
        btnMicro.style.display = 'none';
        console.log("Tu navegador no soporta reconocimiento de voz.");
    }


    // L√ìGICA PARA HACER QUE EL CHAT HABLE
    let vozActivada = false;
    const btnVoz = document.getElementById('btn-voz');
    let vocesDisponibles = [];

    function cargarVoces() {
        vocesDisponibles = window.speechSynthesis.getVoices();
    }

    cargarVoces();
    if (window.speechSynthesis.onvoiceschanged !== undefined) {
        window.speechSynthesis.onvoiceschanged = cargarVoces;
    }

    btnVoz.addEventListener('click', () => {
        vozActivada = !vozActivada;
        
        if (vozActivada) {
            btnVoz.textContent = 'üîä';
            btnVoz.classList.replace('btn-outline-secondary', 'btn-info');
            
            leerTexto("Voz activada.");
        } else {
            btnVoz.textContent = 'üîá';
            btnVoz.classList.replace('btn-info', 'btn-outline-secondary');
            window.speechSynthesis.cancel();
        }
    });

    function leerTexto(textoHTML) {
        if (!vozActivada) return;

        window.speechSynthesis.cancel();

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = textoHTML;
        const textoLimpio = tempDiv.textContent || tempDiv.innerText || "";

        const utterance = new SpeechSynthesisUtterance(textoLimpio);

        if (vocesDisponibles.length === 0) {
            cargarVoces();
        }

        const vozEspanol = vocesDisponibles.find(voz => 
            voz.lang.includes('es') && (voz.name.includes('Google') || voz.name.includes('Spanish'))
        ) || vocesDisponibles.find(voz => voz.lang.includes('es'));

        if (vozEspanol) {
            utterance.voice = vozEspanol;
            console.log("Usando voz:", vozEspanol.name);
        } else {
            console.warn("No se encontr√≥ voz espec√≠fica en espa√±ol, usando default.");
            utterance.lang = 'es-ES';
        }

        utterance.rate = 0.9;
        utterance.pitch = 1; 

        window.speechSynthesis.speak(utterance);
    }

</script>
{% endblock %}