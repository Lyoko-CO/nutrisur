{% extends 'base.html' %}
{% load static %}

{% block title %} Nuevo Pedido - Chatbot {% endblock %}

{% block content %} 
<link rel="stylesheet" href="{% static 'pedidos/css/chatbot.css' %}">

<div class="container-fluid px-4"> <h2 class="text-center mb-4">Haz tu pedido</h2>

    <div class="row">
        
        <div class="col-12 col-lg-5 mb-4 order-1 order-lg-1">
            <div class="card shadow-sm"> <div class="card-header bg-white">
                    <h5 class="mb-0 text-center">Productos</h5>
                </div>
                <div class="card-body p-0">
                    <div class="escaparate-container">
                        <div class="productos-scroll">

                            {% if historial %}
                                <div class="section-divider historial-header">
                                    <span><i class="bi bi-clock-history"></i> Recientes</span>
                                </div>

                                {% for producto in historial %}
                                    <div class="producto-mini" onclick="copiarNombre('{{ producto.nombre }}')" title="{{ producto.nombre }}">
                                        <div class="img-wrapper">
                                            <img data-src="{{ producto.enlace_img }}" alt="{{ producto.nombre }}" loading="lazy">
                                        </div>
                                        <div class="producto-info">
                                            <p class="prod-nombre">{{ producto.nombre }}</p>
                                            <p class="prod-precio">{{ producto.precio }} ‚Ç¨</p>
                                        </div>
                                    </div>
                                {% endfor %}

                                <div class="section-divider catalogo-header">
                                    <span>Cat√°logo</span>
                                </div>

                            {% endif %}


                            {% for producto in productos_escaparate %}
                                <div class="producto-mini" onclick="copiarNombre('{{ producto.nombre }}')" title="{{ producto.nombre }} - {{ producto.precio }}‚Ç¨">
                                    <div class="img-wrapper">
                                        <img data-src="{{ producto.enlace_img }}" alt="{{ producto.nombre }}" loading="lazy">
                                    </div>
                                    <div class="producto-info">
                                        <p class="prod-nombre">{{ producto.nombre }}</p>
                                        <p class="prod-precio">{{ producto.precio }} ‚Ç¨</p>
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-center p-3">Cargando productos...</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-7 order-2 order-lg-2 mb-4">
            <div id="chat-window" class="border p-3 mb-3 shadow-sm rounded" style="background: #f9f9f9;">
                <div class="chat-message bot">
                    <strong>NutriBot:</strong> ¬°Hola, {{ user.nombre|default:user.email }}! Estoy aqu√≠ para tomar tu pedido. ¬øQu√© te gustar√≠a?
                </div>
            </div>

            <form id="chat-form">
                <div class="input-group">
                    <input type="text" id="chat-input" class="form-control" placeholder="Escribe o dicta tu pedido..." required>
                    <button type="button" id="btn-voz" class="btn btn-outline-secondary" title="Activar lectura en voz alta">
                        üîá
                    </button>
                    <button type="button" id="btn-micro" class="btn btn-outline-secondary" title="Dictar pedido">
                        <span id="micro-icon">üéôÔ∏è</span>
                    </button>
                    <button type="submit" id="btn-enviar" class="btn btn-primary">Enviar</button>
                </div>
            </form>
        </div>

    </div> <div class="row">
        <div class="col-12"> <hr class="my-4"> <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Total actual: <span id="total-pedido">{{ pedido.calcular_total|floatformat:2 }}</span>‚Ç¨</h3>
            </div>

            <div class="card shadow-sm mb-5">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Tu Carrito</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="lista-items-pedido">
                                {% for item in pedido.pedidoproducto_set.all %}
                                <tr id="fila-prod-{{ item.producto.id }}">
                                    <td>{{ item.producto.nombre }}</td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-secondary" data-id="{{ item.producto.id }}" onclick="actualizarCantidad(this.dataset.id, 'decrementar')">-</button>
                                            <span class="btn btn-light disabled text-dark fw-bold" style="width: 40px;">{{ item.cantidad }}</span>
                                            <button type="button" class="btn btn-outline-secondary" data-id="{{ item.producto.id }}" onclick="actualizarCantidad(this.dataset.id, 'incrementar')">+</button>
                                        </div>
                                    </td>
                                    <td class="text-end">{{ item.producto.precio }}‚Ç¨</td>
                                    <td class="text-end fw-bold">{{ item.subtotal }}‚Ç¨</td>
                                </tr>
                                {% empty %}
                                <tr id="carrito-vacio">
                                    <td colspan="4" class="text-center text-muted py-3">Tu carrito est√° vac√≠o</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // URL de la API
    const procesarMensajeURL = "{% url 'procesar_mensaje_pedido' %}";

    const actualizarCantidadURL = "{% url 'actualizar_cantidad' %}";
    // Token CSRF para la petici√≥n POST
    const csrfToken = "{{ csrf_token }}";

    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const totalPedidoSpan = document.getElementById('total-pedido');
    const listaItemsBody = document.getElementById('lista-items-pedido')

    function renderizarDesglose(items) {
        listaItemsBody.innerHTML = '';

        if (items.length === 0) {
            listaItemsBody.innerHTML = `
                <tr id="carrito-vacio">
                    <td colspan="4" class="text-center text-muted py-3">Tu carrito est√° vac√≠o</td>
                </tr>`;
            return;
        }

        items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.nombre}</td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="actualizarCantidad(${item.id_producto}, 'decrementar')">-</button>
                        <span class="btn btn-light disabled text-dark fw-bold" style="width: 40px;">${item.cantidad}</span>
                        <button type="button" class="btn btn-outline-secondary" onclick="actualizarCantidad(${item.id_producto}, 'incrementar')">+</button>
                    </div>
                </td>
                <td class="text-end">${item.precio_unitario.toFixed(2)}‚Ç¨</td>
                <td class="text-end fw-bold">${item.subtotal.toFixed(2)}‚Ç¨</td>
            `;
            listaItemsBody.appendChild(row);
        });
    }

    async function actualizarCantidad(idProducto, accion) {
        try {
            const response = await fetch(actualizarCantidadURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ id_producto: idProducto, accion: accion })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                totalPedidoSpan.textContent = data.total_pedido.toFixed(2);
                renderizarDesglose(data.items);
            }
        } catch (error) {
            console.error('Error al actualizar cantidad:', error);
        }
    }

    chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const mensaje = chatInput.value.trim();
            if (mensaje === "") return;

            // 1. Mostrar el mensaje del usuario
            addMessage('T√∫', mensaje);
            chatInput.value = "";
            chatInput.disabled = true;
            chatForm.querySelector('button').disabled = true;

            // 2. Mostrar indicador de "escribiendo..."
            let typingDiv;
            setTimeout(() => {
                typingDiv = document.createElement('div');
                typingDiv.classList.add('chat-message', 'bot');
                typingDiv.innerHTML = `<strong>NutriBot:</strong> <em>escribiendo...</em>`;
                chatWindow.appendChild(typingDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }, 300);


            try {
                // 3. Enviar el mensaje al backend
                const response = await fetch(procesarMensajeURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ mensaje: mensaje })
                });

                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }

                const data = await response.json();
                
                // 4. Remover el indicador de "escribiendo..."
                if (typingDiv) typingDiv.remove();
                
                // 5. Mostrar la respuesta del bot
                addMessage('NutriBot', data.respuesta_bot);
                leerTexto(data.respuesta_bot);

                // 6. Actualizar el total si existe
                if (data.total_pedido !== undefined) {
                    const totalNumerico = parseFloat(data.total_pedido);
                    totalPedidoSpan.textContent = totalNumerico.toFixed(2);
                }
                
                // 7. Actualizar items si existen
                if (data.items) {
                    renderizarDesglose(data.items);
                }
                
                // 8. Si el pedido se finaliza, desactivar el input
                if (data.status === 'finalizado') {
                    chatInput.placeholder = "¬°Pedido confirmado! Pulsa Listo para salir.";
                    chatInput.disabled = true;
                    const btnEnviar = document.getElementById('btn-enviar');
                    btnEnviar.classList.replace('btn-primary', 'btn-success'); 
                    btnEnviar.textContent = "Listo";
                    btnEnviar.type = "button";
                    btnEnviar.onclick = function() {
                        window.location.href = '/citas/mis-citas';
                    };
                    btnEnviar.disabled = false;
                    const btnMicro = document.getElementById('btn-micro');
                    btnMicro.disabled = true;
                    const btnAltavoz = document.getElementById('btn-voz');
                    btnAltavoz.disabled = true;
                } else {
                    chatInput.disabled = false;
                    chatForm.querySelector('button').disabled = false;
                }

            } catch (error) {
                console.error('Error:', error);
                typingDiv.remove();
                addMessage('NutriBot', 'Lo siento, ha ocurrido un error de conexi√≥n. Int√©ntalo de nuevo.');
                chatInput.disabled = false;
                chatForm.querySelector('button').disabled = false;
            }
        });

    // Funci√≥n para a√±adir mensajes a la ventana
    function addMessage(sender, message) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', sender.toLowerCase());
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // Manejar el env√≠o del formulario
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const mensaje = chatInput.value.trim();
        if (mensaje === "") return;

        // 1. Mostrar el mensaje del usuario
        addMessage('T√∫', mensaje);
        chatInput.value = "";

        try {
            // 2. Enviar el mensaje al backend (views.py)
            const response = await fetch(procesarMensajeURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ mensaje: mensaje })
            });

            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }

            const data = await response.json();
            
            // 3. Mostrar la respuesta del bot
            addMessage('NutriBot', data.respuesta_bot);

            // 4. Actualizar el total si existe
            if (data.total_pedido !== undefined) {
                const totalNumerico = parseFloat(data.total_pedido);
                totalPedidoSpan.textContent = totalNumerico.toFixed(2);
            }
            
            // 5. Si el pedido se finaliza, desactivar el input
            if (data.status === 'finalizado') {
                    chatInput.disabled = true;
                    chatForm.querySelector('button').disabled = true;
                    
                    // Redirigir a "Mis Pedidos" despu√©s de 2 segundos
                    setTimeout(function() {
                        window.location.href = "{% url 'mis_pedidos' %}";
                    }, 2000);
                    
                } else {
                    chatInput.disabled = false;
                    chatForm.querySelector('button').disabled = false;
                }

        } catch (error) {
            console.error('Error:', error);
            addMessage('NutriBot', 'Lo siento, ha ocurrido un error de conexi√≥n. Int√©ntalo de nuevo.');
        }
    });

    function copiarNombre(nombreProducto) {
        const inputChat = document.getElementById('chat-input');
        
        if (inputChat) {
            inputChat.value = "Quiero " + nombreProducto;
            inputChat.focus();
        } else {
            console.error("Error: No encuentro el input con id 'chat-input'");
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const productImages = document.querySelectorAll('.img-wrapper img');

        productImages.forEach(img => {
            const imageUrl = img.dataset.src;
            const imgWrapper = img.closest('.img-wrapper');

            const tempImg = new Image();
            tempImg.src = imageUrl;

            tempImg.onload = () => {
                img.src = imageUrl; 
                imgWrapper.classList.add('loaded');
            };

            tempImg.onerror = () => { 
                imgWrapper.classList.add('loaded');
                console.error('Error al cargar la imagen:', imageUrl);
            };
        });
    });
    const btnMicro = document.getElementById('btn-micro');
    const microIcon = document.getElementById('micro-icon');

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.lang = 'es-ES'; // Espa√±ol
        recognition.continuous = false; // Detener al dejar de hablar
        recognition.interimResults = false; // Solo resultados finales

        // Evento click del micr√≥fono
        btnMicro.addEventListener('click', () => {
            if (btnMicro.classList.contains('recording')) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        // Al empezar a grabar
        recognition.onstart = () => {
            btnMicro.classList.add('recording');
            btnMicro.classList.replace('btn-outline-secondary', 'btn-danger'); // Cambia a rojo
            microIcon.textContent = '‚èπÔ∏è';
            chatInput.placeholder = "Te escucho...";
        };

        // Al terminar de grabar
        recognition.onend = () => {
            btnMicro.classList.remove('recording');
            btnMicro.classList.replace('btn-danger', 'btn-outline-secondary'); // Vuelve a gris
            microIcon.textContent = 'üéôÔ∏è';
            chatInput.placeholder = "Escribe tu mensaje...";
            chatInput.focus();
        };

        // Al recibir el texto
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            chatInput.value = transcript;
            
            // Opcional: Enviar autom√°ticamente tras una peque√±a pausa
            // setTimeout(() => chatForm.dispatchEvent(new Event('submit')), 500);
        };

        recognition.onerror = (event) => {
            console.error("Error de voz:", event.error);
            recognition.stop();
        };

    } else {
        // Ocultar bot√≥n si el navegador no es compatible
        btnMicro.style.display = 'none';
    }


    // L√ìGICA PARA HACER QUE EL CHAT HABLE
    let vozActivada = false;
    const btnVoz = document.getElementById('btn-voz');
    let vocesDisponibles = [];

    function cargarVoces() {
        vocesDisponibles = window.speechSynthesis.getVoices();
    }

    cargarVoces();
    if (window.speechSynthesis.onvoiceschanged !== undefined) {
        window.speechSynthesis.onvoiceschanged = cargarVoces;
    }

    btnVoz.addEventListener('click', () => {
        vozActivada = !vozActivada;
        
        if (vozActivada) {
            btnVoz.textContent = 'üîä';
            btnVoz.classList.replace('btn-outline-secondary', 'btn-info');
            
            leerTexto("Voz activada.");
        } else {
            btnVoz.textContent = 'üîá';
            btnVoz.classList.replace('btn-info', 'btn-outline-secondary');
            window.speechSynthesis.cancel();
        }
    });

    function leerTexto(textoHTML) {
        if (!vozActivada) return;

        window.speechSynthesis.cancel();

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = textoHTML;
        const textoLimpio = tempDiv.textContent || tempDiv.innerText || "";

        const utterance = new SpeechSynthesisUtterance(textoLimpio);

        if (vocesDisponibles.length === 0) {
            cargarVoces();
        }

        const vozEspanol = vocesDisponibles.find(voz => 
            voz.lang.includes('es') && (voz.name.includes('Google') || voz.name.includes('Spanish'))
        ) || vocesDisponibles.find(voz => voz.lang.includes('es'));

        if (vozEspanol) {
            utterance.voice = vozEspanol;
            console.log("Usando voz:", vozEspanol.name);
        } else {
            console.warn("No se encontr√≥ voz espec√≠fica en espa√±ol, usando default.");
            utterance.lang = 'es-ES';
        }

        utterance.rate = 0.9;
        utterance.pitch = 1; 

        window.speechSynthesis.speak(utterance);
    }

</script>
{% endblock %}