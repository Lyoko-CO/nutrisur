{% extends 'base.html' %}
{% load static %}

{% block title %} Nuevo Pedido - Chatbot {% endblock %}

{% block content %} 
<link rel="stylesheet" href="{% static 'pedidos/css/chatbot.css' %}">

<div class="container-fluid px-4"> <h2 class="text-center mb-4">Haz tu pedido</h2>

    <div class="row">
        
        <div class="col-12 col-lg-5 mb-4 order-1 order-lg-1">
            <div class="card shadow-sm"> <div class="card-header bg-white">
                    <h5 class="mb-0 text-center">Productos</h5>
                </div>
                <div class="card-body p-0">
                    <div class="escaparate-container">
                        <div class="productos-scroll">

                            {% if historial %}
                                <div class="section-divider historial-header">
                                    <span><i class="bi bi-clock-history"></i> Recientes</span>
                                </div>

                                {% for producto in historial %}
                                    <div class="producto-mini" onclick="copiarNombre('{{ producto.nombre }}')" title="{{ producto.nombre }}">
                                        <div class="img-wrapper">
                                            <img data-src="{{ producto.enlace_img }}" alt="{{ producto.nombre }}" loading="lazy">
                                        </div>
                                        <div class="producto-info">
                                            <p class="prod-nombre">{{ producto.nombre }}</p>
                                            <p class="prod-precio">{{ producto.precio }} €</p>
                                        </div>
                                    </div>
                                {% endfor %}

                                <div class="section-divider catalogo-header">
                                    <span>Catálogo</span>
                                </div>

                            {% endif %}


                            {% for producto in productos_escaparate %}
                                <div class="producto-mini" onclick="copiarNombre('{{ producto.nombre }}')" title="{{ producto.nombre }} - {{ producto.precio }}€">
                                    <div class="img-wrapper">
                                        <img data-src="{{ producto.enlace_img }}" alt="{{ producto.nombre }}" loading="lazy">
                                    </div>
                                    <div class="producto-info">
                                        <p class="prod-nombre">{{ producto.nombre }}</p>
                                        <p class="prod-precio">{{ producto.precio }} €</p>
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-center p-3">Cargando productos...</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-7 order-2 order-lg-2 mb-4">
            <div id="chat-window" class="border p-3 mb-3 shadow-sm rounded" style="background: #f9f9f9;">
                <div class="chat-message bot">
                    <strong>NutriBot:</strong> ¡Hola, {{ user.nombre|default:user.email }}! Estoy aquí para tomar tu pedido. ¿Qué te gustaría?
                </div>
            </div>

            <form id="chat-form">
                <div class="input-group input-group-lg">
                    <input type="text" id="chat-input" class="form-control" placeholder="Ej: Quiero proteína de suero..." required>
                    <button type="submit" class="btn btn-primary px-4">Enviar</button>
                </div>
            </form>
        </div>

    </div> <div class="row">
        <div class="col-12"> <hr class="my-4"> <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Total actual: <span id="total-pedido">{{ pedido.calcular_total|floatformat:2 }}</span>€</h3>
            </div>

            <div class="card shadow-sm mb-5">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Tu Carrito</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="lista-items-pedido">
                                {% for item in pedido.pedidoproducto_set.all %}
                                <tr id="fila-prod-{{ item.producto.id }}">
                                    <td>{{ item.producto.nombre }}</td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-secondary" data-id="{{ item.producto.id }}" onclick="actualizarCantidad(this.dataset.id, 'decrementar')">-</button>
                                            <span class="btn btn-light disabled text-dark fw-bold" style="width: 40px;">{{ item.cantidad }}</span>
                                            <button type="button" class="btn btn-outline-secondary" data-id="{{ item.producto.id }}" onclick="actualizarCantidad(this.dataset.id, 'incrementar')">+</button>
                                        </div>
                                    </td>
                                    <td class="text-end">{{ item.producto.precio }}€</td>
                                    <td class="text-end fw-bold">{{ item.subtotal }}€</td>
                                </tr>
                                {% empty %}
                                <tr id="carrito-vacio">
                                    <td colspan="4" class="text-center text-muted py-3">Tu carrito está vacío</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // URL de la API
    const procesarMensajeURL = "{% url 'procesar_mensaje_pedido' %}";

    const actualizarCantidadURL = "{% url 'actualizar_cantidad' %}";
    // Token CSRF para la petición POST
    const csrfToken = "{{ csrf_token }}";

    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const totalPedidoSpan = document.getElementById('total-pedido');
    const listaItemsBody = document.getElementById('lista-items-pedido')

    function renderizarDesglose(items) {
        listaItemsBody.innerHTML = '';

        if (items.length === 0) {
            listaItemsBody.innerHTML = `
                <tr id="carrito-vacio">
                    <td colspan="4" class="text-center text-muted py-3">Tu carrito está vacío</td>
                </tr>`;
            return;
        }

        items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.nombre}</td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="actualizarCantidad(${item.id_producto}, 'decrementar')">-</button>
                        <span class="btn btn-light disabled text-dark fw-bold" style="width: 40px;">${item.cantidad}</span>
                        <button type="button" class="btn btn-outline-secondary" onclick="actualizarCantidad(${item.id_producto}, 'incrementar')">+</button>
                    </div>
                </td>
                <td class="text-end">${item.precio_unitario.toFixed(2)}€</td>
                <td class="text-end fw-bold">${item.subtotal.toFixed(2)}€</td>
            `;
            listaItemsBody.appendChild(row);
        });
    }

    async function actualizarCantidad(idProducto, accion) {
        try {
            const response = await fetch(actualizarCantidadURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ id_producto: idProducto, accion: accion })
            });

            const data = await response.json();
            if (data.status === 'ok') {
                totalPedidoSpan.textContent = data.total_pedido.toFixed(2);
                renderizarDesglose(data.items);
            }
        } catch (error) {
            console.error('Error al actualizar cantidad:', error);
        }
    }

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const mensaje = chatInput.value.trim();
        if (mensaje === "") return;

        addMessage('Tú', mensaje);
        chatInput.value = "";

        try {
            const response = await fetch(procesarMensajeURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ mensaje: mensaje })
            });

            const data = await response.json();
            
            addMessage('NutriBot', data.respuesta_bot);

            if (data.total_pedido !== undefined) {
                totalPedidoSpan.textContent = parseFloat(data.total_pedido).toFixed(2);
            }

            if (data.items) {
                renderizarDesglose(data.items);
            }

            if (data.status === 'finalizado') {
                chatInput.disabled = true;
                chatForm.querySelector('button').disabled = true;
            }

        } catch (error) {
            console.error('Error:', error);
            addMessage('NutriBot', 'Error de conexión.');
        }
    });

    // Función para añadir mensajes a la ventana
    function addMessage(sender, message) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', sender.toLowerCase());
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // Manejar el envío del formulario
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const mensaje = chatInput.value.trim();
        if (mensaje === "") return;

        // 1. Mostrar el mensaje del usuario
        addMessage('Tú', mensaje);
        chatInput.value = "";

        try {
            // 2. Enviar el mensaje al backend (views.py)
            const response = await fetch(procesarMensajeURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ mensaje: mensaje })
            });

            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }

            const data = await response.json();
            
            // 3. Mostrar la respuesta del bot
            addMessage('NutriBot', data.respuesta_bot);

            // 4. Actualizar el total si existe
            if (data.total_pedido !== undefined) {
                const totalNumerico = parseFloat(data.total_pedido);
                totalPedidoSpan.textContent = totalNumerico.toFixed(2);
            }
            
            // 5. Si el pedido se finaliza, desactivar el input
            if (data.status === 'finalizado') {
                chatInput.disabled = true;
                chatForm.querySelector('button').disabled = true;
            }

        } catch (error) {
            console.error('Error:', error);
            addMessage('NutriBot', 'Lo siento, ha ocurrido un error de conexión. Inténtalo de nuevo.');
        }
    });

    function copiarNombre(nombreProducto) {
        const inputChat = document.getElementById('chat-input');
        
        if (inputChat) {
            inputChat.value = "Quiero " + nombreProducto;
            inputChat.focus();
        } else {
            console.error("Error: No encuentro el input con id 'chat-input'");
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const productImages = document.querySelectorAll('.img-wrapper img');

        productImages.forEach(img => {
            const imageUrl = img.dataset.src;
            const imgWrapper = img.closest('.img-wrapper');

            const tempImg = new Image();
            tempImg.src = imageUrl;

            tempImg.onload = () => {
                img.src = imageUrl; 
                imgWrapper.classList.add('loaded');
            };

            tempImg.onerror = () => { 
                imgWrapper.classList.add('loaded');
                console.error('Error al cargar la imagen:', imageUrl);
            };
        });
    });

</script>
{% endblock %}