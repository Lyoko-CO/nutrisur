{% extends 'base.html' %}

{% block title %}Mis Pedidos - NutriSur{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 offset-lg-1">
        
        <h2 class="mb-4">Historial de Mis Pedidos</h2>

        <div class="accordion" id="accordionPedidos">

            {% if pedidos %}
            
                {% for pedido in pedidos %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-{{ pedido.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ pedido.id }}" aria-expanded="false" aria-controls="collapse-{{ pedido.id }}">
                            <span class="fw-bold me-3">Pedido #{{ pedido.id }}</span>
                            <span class="me-3 d-none d-sm-inline">Fecha: {{ pedido.fecha_pedido|date:"d/m/Y" }}</span>
                            
                            {% if pedido.estado == 'P' %}
                                <span class="badge bg-warning text-dark me-3">Pendiente</span>
                            {% elif pedido.estado == 'R' %}
                                <span class="badge bg-success me-3">Realizado</span>
                            {% elif pedido.estado == 'C' %}
                                <span class="badge bg-danger me-3">Cancelado</span>
                            {% endif %}

                            <span class="ms-auto fw-bold">{{ pedido.calcular_total|floatformat:2 }} €</span>
                        </button>
                    </h2>
                    <div id="collapse-{{ pedido.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ pedido.id }}" data-bs-parent="#accordionPedidos">
                        <div class="accordion-body">
                            <h6 class="mb-3 text-muted">Detalles del pedido:</h6>
                            <ul class="list-group mb-3">
                                {% for item in pedido.pedidoproducto_set.all %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>
                                            <span class="fw-bold">{{ item.cantidad }}x</span> {{ item.producto.nombre }}
                                        </span>
                                        <span>
                                            {{ item.subtotal|floatformat:2 }} €
                                        </span>
                                    </li>
                                {% endfor %}
                            </ul>

                            {% if pedido.estado == 'P' %}
                                <div class="d-flex justify-content-end gap-2 border-top pt-3">
                                    <a href="{% url 'modificar_pedido' pedido.id %}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-pencil"></i> Modificar Pedido
                                    </a>
                                    
                                    <a href="{% url 'cancelar_pedido' pedido.id %}" 
                                       class="btn btn-outline-danger btn-sm"
                                       onclick="return confirm('¿Estás seguro de que quieres cancelar este pedido?');">
                                        <i class="bi bi-x-circle"></i> Cancelar
                                    </a>
                                </div>
                            {% endif %}
                            
                        </div>
                    </div>
                </div>
            {% endfor %}

            {% else %}
                <div class="alert alert-secondary" role="alert">
                    Aún no has realizado ningún pedido.
                </div>
            {% endif %}

        </div> </div>
</div>
{% endblock %}